<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Coraz√≥n Studio AI ‚ú®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1630;
      --text:#ffffff;
      --muted:rgba(255,255,255,.7);
      --accent:#6c5cff;
      --accent2:#8f86ff;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    body{
      margin:0; padding:18px;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(108,92,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, rgba(143,134,255,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:720px; margin:0 auto;}
    .title{
      display:flex; align-items:center; gap:10px;
      font-size:34px; font-weight:800;
      margin:8px 0 14px;
    }
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      padding:10px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      margin-bottom:14px;
    }
    .tab{
      border:0; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      background:transparent;
      color:var(--muted);
      font-weight:700;
    }
    .tab.active{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:white;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }
    .h2{font-size:20px; font-weight:800; margin:0 0 12px;}
    textarea, input, select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-size:16px;
      box-sizing:border-box;
    }
    textarea{min-height:110px; resize:vertical;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    .btn{
      width:100%;
      border:0;
      padding:14px 16px;
      font-size:16px;
      font-weight:800;
      color:white;
      border-radius: 14px;
      cursor:pointer;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      margin-top:10px;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      color: white;
    }
    .row{display:flex; gap:10px; align-items:center;}
    .small{font-size:13px; color:var(--muted); margin-top:8px;}
    video, img, audio{
      width:100%;
      border-radius: 16px;
      margin-top:12px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--stroke);
    }

    /* Switch premium */
    .switchRow{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      margin-top:10px;
    }
    .switchRow .label{
      font-weight:800;
    }
    .switchRow .sub{
      font-size:12px; color:var(--muted); margin-top:4px;
      font-weight:600;
    }
    .switch{
      position: relative;
      width:52px; height:30px;
    }
    .switch input{display:none;}
    .slider{
      position:absolute; inset:0;
      background: rgba(255,255,255,.18);
      border:1px solid var(--stroke);
      border-radius:999px;
      transition:.2s;
    }
    .slider:before{
      content:"";
      position:absolute; width:24px; height:24px;
      left:3px; top:2.5px;
      background:white;
      border-radius:50%;
      transition:.2s;
    }
    .switch input:checked + .slider{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    .switch input:checked + .slider:before{
      transform: translateX(21px);
    }

    .presetBar{
      display:flex; gap:10px; align-items:center;
      margin-top:12px;
    }
    .presetBar select{flex:1;}
    .presetBar button{flex:0 0 auto; padding:12px 14px; border-radius:14px;}
    .hide{display:none;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="title">üíú Coraz√≥n Studio AI</div>

  <div class="tabs">
    <button class="tab active" id="tabCine" onclick="showTab('cine')">üé¨ Cine</button>
    <button class="tab" id="tabReels" onclick="showTab('reels')">üì± Reels</button>
    <button class="tab" id="tabImage" onclick="showTab('image')">üñºÔ∏è Imagen</button>
    <button class="tab" id="tabChat" onclick="showTab('chat')">üí¨ Chat</button>
  </div>

  <!-- PRESETS -->
  <div class="card">
    <div class="h2">‚≠ê Presets (Reels / Cine)</div>
    <div class="presetBar">
      <select id="presetSelect"></select>
      <button class="btn secondary" onclick="savePreset()">Guardar</button>
      <button class="btn secondary" onclick="deletePreset()">Borrar</button>
    </div>
    <div class="small">Tip: Crea un preset ‚ÄúReels ES Voz F + M√∫sica suave‚Äù y otro ‚ÄúCine EN Voz M + Cinematic‚Äù.</div>
  </div>

  <!-- CINE -->
  <div class="card" id="panelCine">
    <div class="h2">üé¨ Video Cine (con Voz + M√∫sica)</div>

    <textarea id="cineText" placeholder="Describe el video cine..."></textarea>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>üåé Idioma</label>
        <select id="cineLanguage">
          <option value="es">Espa√±ol</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>üéôÔ∏è Voz</label>
        <select id="cineGender">
          <option value="female">Femenina</option>
          <option value="male">Masculina</option>
        </select>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>‚è±Ô∏è Duraci√≥n</label>
        <select id="cineDuration">
          <option value="5">5s</option>
          <option value="6">6s</option>
          <option value="8">8s</option>
        </select>
      </div>
      <div>
        <label>üé∂ M√∫sica</label>
        <select id="cineMusic">
          <option value="soft">Suave</option>
          <option value="cinematic">Cinem√°tica</option>
          <option value="none">Sin m√∫sica</option>
        </select>
      </div>
    </div>

    <div class="switchRow">
      <div>
        <div class="label">üó£Ô∏è Narrador + Personajes</div>
        <div class="sub">Apaga = solo narrador</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="cineCharacters" />
        <span class="slider"></span>
      </label>
    </div>

    <button class="btn" onclick="generateCine()">Generar Cine con Voz</button>

    <video id="cineVideo" controls playsinline></video>
    <div class="small" id="cineStatus"></div>
  </div>

  <!-- REELS -->
  <div class="card hide" id="panelReels">
    <div class="h2">üì± Reels (con Voz + M√∫sica)</div>

    <textarea id="reelsText" placeholder="Texto del reels..."></textarea>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>üåé Idioma</label>
        <select id="reelsLanguage">
          <option value="es">Espa√±ol</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>üéôÔ∏è Voz</label>
        <select id="reelsGender">
          <option value="female">Femenina</option>
          <option value="male">Masculina</option>
        </select>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>‚è±Ô∏è Duraci√≥n</label>
        <select id="reelsDuration">
          <option value="6">6s</option>
          <option value="8">8s</option>
          <option value="10">10s</option>
        </select>
      </div>
      <div>
        <label>üé∂ M√∫sica</label>
        <select id="reelsMusic">
          <option value="soft">Suave</option>
          <option value="cinematic">Cinem√°tica</option>
          <option value="none">Sin m√∫sica</option>
        </select>
      </div>
    </div>

    <div class="switchRow">
      <div>
        <div class="label">üó£Ô∏è Narrador + Personajes</div>
        <div class="sub">Apaga = solo narrador</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="reelsCharacters" />
        <span class="slider"></span>
      </label>
    </div>

    <button class="btn" onclick="generateReels()">Generar Reels con Voz</button>

    <video id="reelsVideo" controls playsinline></video>
    <div class="small" id="reelsStatus"></div>
  </div>

  <!-- IMAGE -->
  <div class="card hide" id="panelImage">
    <div class="h2">üñºÔ∏è Imagen</div>
    <textarea id="imgPrompt" placeholder="Describe la imagen..."></textarea>
    <button class="btn" onclick="generateImage()">Generar Imagen</button>
    <img id="imgOut" />
    <div class="small" id="imgStatus"></div>
  </div>

  <!-- CHAT -->
  <div class="card hide" id="panelChat">
    <div class="h2">üí¨ Chat</div>
    <textarea id="chatMsg" placeholder="Escribe tu mensaje..."></textarea>
    <button class="btn" onclick="sendChat()">Enviar</button>
    <div class="card" style="background:rgba(0,0,0,.18); margin-top:12px">
      <div class="h2" style="margin-bottom:8px">Respuesta</div>
      <div id="chatOut" style="white-space:pre-wrap; color:var(--muted)"></div>
    </div>
  </div>

</div>

<script>
  // -----------------------
  // Tabs
  // -----------------------
  function showTab(name){
    const map = {
      cine: ["panelCine","tabCine"],
      reels:["panelReels","tabReels"],
      image:["panelImage","tabImage"],
      chat: ["panelChat","tabChat"],
    };
    for(const k in map){
      document.getElementById(map[k][0]).classList.add("hide");
      document.getElementById(map[k][1]).classList.remove("active");
    }
    document.getElementById(map[name][0]).classList.remove("hide");
    document.getElementById(map[name][1]).classList.add("active");
    applyPresetToUI();
  }

  // -----------------------
  // Presets
  // -----------------------
  const PRESET_KEY = "corazon_presets_v1";

  function getPresets(){
    try { return JSON.parse(localStorage.getItem(PRESET_KEY) || "[]"); }
    catch(e){ return []; }
  }

  function setPresets(list){
    localStorage.setItem(PRESET_KEY, JSON.stringify(list));
  }

  function refreshPresetSelect(){
    const sel = document.getElementById("presetSelect");
    const list = getPresets();
    if(list.length === 0){
      sel.innerHTML = `<option value="">(sin presets)</option>`;
      return;
    }
    sel.innerHTML = list.map((p,i)=>`<option value="${i}">${p.name}</option>`).join("");
  }

  function currentUIState(){
    return {
      cine: {
        language: cineLanguage.value,
        gender: cineGender.value,
        duration: cineDuration.value,
        music: cineMusic.value,
        characters: cineCharacters.checked
      },
      reels: {
        language: reelsLanguage.value,
        gender: reelsGender.value,
        duration: reelsDuration.value,
        music: reelsMusic.value,
        characters: reelsCharacters.checked
      }
    };
  }

  function applyState(state){
    if(!state) return;

    if(state.cine){
      cineLanguage.value = state.cine.language || "es";
      cineGender.value = state.cine.gender || "female";
      cineDuration.value = state.cine.duration || "5";
      cineMusic.value = state.cine.music || "soft";
      cineCharacters.checked = !!state.cine.characters;
    }
    if(state.reels){
      reelsLanguage.value = state.reels.language || "es";
      reelsGender.value = state.reels.gender || "female";
      reelsDuration.value = state.reels.duration || "6";
      reelsMusic.value = state.reels.music || "soft";
      reelsCharacters.checked = !!state.reels.characters;
    }
  }

  function savePreset(){
    const name = prompt("Nombre del preset (ej: Reels ES Voz F Soft):");
    if(!name) return;

    const list = getPresets();
    list.unshift({ name, state: currentUIState() });
    setPresets(list.slice(0, 30)); // m√°ximo 30
    refreshPresetSelect();
    presetSelect.value = "0";
  }

  function deletePreset(){
    const idx = presetSelect.value;
    if(idx === "" || idx == null) return;
    const list = getPresets();
    if(!list[idx]) return;
    if(!confirm(`Borrar preset "${list[idx].name}"?`)) return;
    list.splice(idx,1);
    setPresets(list);
    refreshPresetSelect();
  }

  function applyPresetToUI(){
    const idx = presetSelect.value;
    if(idx === "" || idx == null) return;
    const list = getPresets();
    const preset = list[idx];
    if(preset && preset.state) applyState(preset.state);
  }

  document.addEventListener("change", (e)=>{
    if(e.target && e.target.id === "presetSelect"){
      applyPresetToUI();
    }
  });

  refreshPresetSelect();

  // -----------------------
  // API calls
  // -----------------------
  async function generateReels(){
    reelsStatus.textContent = "Generando reels con voz...";
    const body = {
      text: reelsText.value,
      duration: parseInt(reelsDuration.value, 10),
      format: "9:16",
      language: reelsLanguage.value,
      voice_gender: reelsGender.value,
      mode: reelsCharacters.checked ? "narrator_plus_character" : "narrator_only",
      music: reelsMusic.value
    };

    const res = await fetch("/reels-voice", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if(data.video_url){
      reelsVideo.src = data.video_url;
      reelsVideo.load();
      reelsVideo.play();
      reelsStatus.textContent = "‚úÖ Reels listo";
    } else {
      reelsStatus.textContent = "‚ùå Error: " + (data.message || "no se pudo generar");
      alert(reelsStatus.textContent);
    }
  }

  async function generateCine(){
    cineStatus.textContent = "Generando cine con voz...";
    const body = {
      text: cineText.value,
      duration: parseInt(cineDuration.value, 10),
      format: "9:16",
      language: cineLanguage.value,
      voice_gender: cineGender.value,
      mode: cineCharacters.checked ? "narrator_plus_character" : "narrator_only",
      music: cineMusic.value
    };

    // Usa el nuevo endpoint
    const res = await fetch("/video-cine-voice", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if(data.video_url){
      cineVideo.src = data.video_url;
      cineVideo.load();
      cineVideo.play();
      cineStatus.textContent = "‚úÖ Cine listo";
    } else {
      cineStatus.textContent = "‚ùå Error: " + (data.message || "no se pudo generar");
      alert(cineStatus.textContent);
    }
  }

  async function generateImage(){
    imgStatus.textContent = "Generando imagen...";
    const res = await fetch("/image", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ prompt: imgPrompt.value, size: "1024x1024" })
    });
    const data = await res.json();
    if(data.image_url){
      imgOut.src = data.image_url;
      imgStatus.textContent = "‚úÖ Imagen lista";
    } else {
      imgStatus.textContent = "‚ùå Error";
      alert(JSON.stringify(data));
    }
  }

  async function sendChat(){
    chatOut.textContent = "Escribiendo...";
    const res = await fetch("/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message: chatMsg.value })
    });
    const data = await res.json();
    chatOut.textContent = data.reply || "(sin respuesta)";
  }
</script>

</body>
</html>
